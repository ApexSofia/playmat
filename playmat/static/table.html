<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Playmat for role playing games</title>
		<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
		<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
		<script src="./helper.js"></script>
		<script src="./board.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/ui-darkness/jquery-ui.css">
		<link rel="stylesheet" type="text/css" href="./style.css">
		<link rel="icon" type="image/x-icon" href="favicon.ico">
		<script>
			$(function() {				
				var buildMenu = (menu, position) => {
					$('#'+menu).dialog({
						position: position,
						autoOpen: false,
						width: 'auto',
						height: 'auto',
						show: {
							effect: "blind",
							duration: 500
						},
						hide: {
							effect: "blind",
							duration: 500
						}
					});
					$('div[aria-describedby='+menu+'] div.ui-dialog-titlebar').hide();
					$('#'+menu).parent().css({position:"fixed"});
					$('#'+menu.replace('Menu', 'Button')).on().click(function (){
						toggleMenu(menu);
					});
				};
			
				var id = $('#playmatId').val();
				if (id == -1) {
					betterAlert('An error has ocurrerd, redirecting to main screen', 'Error', function(){
						window.location.href = 'index.html' ;
					});
				} else {
					processBoard(JSON.parse($('#initialData').val()));
					
					$('#playmatNameShow').text($('#playmatName').val());
					$('#playmatPassShow').text($('#playmatPass').val());
					
					buildMenu('mainMenu',       { my: "left top+5",    at: "left bottom", of: $('#mainButton') });
					buildMenu('playmatMenu',    { my: "left+10 top-5", at: "right top",   of: $('#mainMenu') });
					buildMenu('backgroundMenu', { my: "left+10 top-5", at: "right top",   of: $('#mainMenu') });
					buildMenu('tokenMenu',      { my: "left+10 top-5", at: "right top",   of: $('#mainMenu') });
					
					var process = (res) => {
						$('#mainMenu').dialog('close');
						$('#backgroundMenu').dialog('close');
						$('#tokenMenu').dialog('close');
						if (res.success == false) {
							betterAlert(res.error.code || res.error, 'An error has ocurred.')
						}
						if (res.objects) {
							processBoard(res.objects);
						}
					};
					
					$('#uploadBackgroundButton').on().click(function (){
						var props = { type: 'background', playmat: id } ;
						fileDialog(true, '/upload',['.jpg','.png','.gif'],'Upload a background', 'File upload', props, process);
					});
					$('#importBackgroundButton').on().click(function (){
						var props = { type: 'background', playmat: id } ;
						fileDialog(false, '/import',['.jpg','.png','.gif'],'Import a background', 'File import', props, process);
					});
					$('#existBackgroundButton').on().click(function (){
						var html = '<ul id="backgroundLibrayList"></ul>' ;
						var dialog = $('<div></div>').html(html).dialog({
							width: 'auto',
							modal: true,
							resizable: false,
							title: 'Available backgrounds',
							beforeClose: () => {
								$('#backgroundLibrayList').parent().remove();
							}
						});
						$.post('/getObjects',{ type:'background' },(res) => {
							res = JSON.parse(res);
							if (res.success == false) {
								betterAlert(res.error.code || res.error, 'An error has ocurred.');
							} else {
								for (var i = 0 ; i < res.savedObjects.length ; i++) {
									var obj = res.savedObjects[i];
									var url = obj.name ;
									if (!(url.indexOf('http://') == 0 || url.indexOf('https://')) == 0) {
										url = './assets/' + url ;
									}
									var code = '<li class="library" id="library_'+obj.rowid+'" alias="'+obj.alias+'" >'+obj.alias+'</div>';
									$('#backgroundLibrayList').append(code);
									$('#library_'+obj.rowid).on().click(function (event) {
										$.post('/reUseToken', { playmat: id, alias: $(this).attr('alias'), x: $(window).scrollLeft(), y: $(window).scrollTop() }, (res)=>{
											dialog.dialog('close');
											process(JSON.parse(res));
										});
									});
								}
							}
						});
					});
					$('#uploadTokenButton').on().click(function (){
						var props = { type: 'token', playmat: id, x: $(window).scrollLeft(), y: $(window).scrollTop() } ;
						fileDialog(true, '/upload',['.jpg','.png','.gif'],'Upload a token', 'File upload', props, process);
					});
					$('#importTokenButton').on().click(function (){
						var props = { type: 'token', playmat: id, x: $(window).scrollLeft(), y: $(window).scrollTop() } ;
						fileDialog(false, '/import',['.jpg','.png','.gif'],'Import a token', 'File import', props, process);
					});
					$('#existTokenButton').on().click(function (){
						var html = '<div class="thumbContainer"></div>' ;
						var dialog = $('<div></div>').html(html).dialog({
							width: 'auto',
							modal: true,
							resizable: false,
							title: 'Available tokens',
							beforeClose: () => {
								$('.thumbContainer').parent().remove();
							}
						});
						$('.thumbContainer').parent().parent().css({position:"fixed", left:"30px", right:"30px", top:"30px", bottom:"30px", 'overflow-y': "auto"});
						$.post('/getObjects',{ type:'token' },(res) => {
							res = JSON.parse(res);
							if (res.success == false) {
								betterAlert(res.error.code || res.error, 'An error has ocurred.');
							} else {
								for (var i = 0 ; i < res.savedObjects.length ; i++) {
									var obj = res.savedObjects[i];
									var url = obj.name ;
									if (!(url.indexOf('http://') == 0 || url.indexOf('https://')) == 0) {
										url = './assets/' + url ;
									}
									var code = '<div class="previewHolder" id="preview_'+obj.rowid+'" alias="'+obj.alias+'"><img src="'+url+'" class="imagePreview"><br/>'+obj.alias+'</div>';
									$('.thumbContainer').append(code);
									$('#preview_'+obj.rowid).on().click(function (event) {
										$.post('/reUseToken', { playmat: id, alias: $(this).attr('alias'), x: $(window).scrollLeft(), y: $(window).scrollTop() }, (res)=>{
											dialog.dialog('close');
											process(JSON.parse(res));
										});
									});
								}
							}
						});
					});
					$('#exitButton').on().click(function() {
						betterConfirm('Do you really want to exit?','Confirm',
							() => { window.location.href = 'index.html' ; },
							() => { toggleMenu('mainMenu'); })
					});
				}
			});
		</script>
	</head>
	<body>
		<input id="playmatId" type="hidden" value="-1"/>
		<div class="hamburguer" id="mainButton">&#9776;</div>
		<div class="dialog" id="mainMenu" style="display: none">
			<div class="menuSelection" id="playmatButton"   >Playmat info</div>
			<div class="menuSelection" id="backgroundButton">Background</div>
			<div class="menuSelection" id="tokenButton"     >Tokens</div>
			<div class="menuSelection" id="exitButton"      >Exit</div>
		</div>
		<div class="dialog" id="playmatMenu" style="display: none" parentMenu="mainMenu">
			<div class="menuPlaceholder" id="playmatNameHolder"    >Playmat name: <span     class="mark" id="playmatNameShow"></span></div>
			<div class="menuPlaceholder" id="playmatPasswordHolder">Playmat password: <span class="mark" id="playmatPassShow"></span></div>
			<div class="menuPlaceholder"                           >&nbsp;</div>
			<div class="menuSelection"   id="destroyPlaymatButton" >Destroy this playmat</div>
		</div>
		<div class="dialog" id="backgroundMenu" style="display: none" parentMenu="mainMenu">
			<div class="menuSelection" id="uploadBackgroundButton" >Upload a new background</div>
			<div class="menuSelection" id="importBackgroundButton" >Import a background from the web</div>
			<div class="menuSelection" id="existBackgroundButton"  >Use an existing background</div>
			<div class="menuPlaceholder"                           >&nbsp;</div>
		</div>
		<div class="dialog" id="tokenMenu" style="display: none" parentMenu="mainMenu">
			<div class="menuSelection" id="uploadTokenButton" >Upload a new token</div>
			<div class="menuSelection" id="importTokenButton" >Import a token from the web</div>
			<div class="menuSelection" id="existTokenButton"  >Use an existing token</div>
			<div class="menuPlaceholder"                           >&nbsp;</div>
		</div>
	</body>
</html>